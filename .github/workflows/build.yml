name: Check by build

on:
  push:
    paths:
      - '**.ino'
  workflow_dispatch:


jobs:

  # Compile code

  compile:

    runs-on: macos-latest
    
    steps:

      # Clone repository

      - name: Clone repository
        uses: actions/checkout@main

      # Setup arduino CLI

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@master

      # Configure platform

      - name: Configure platform
        run: |
          arduino-cli config init 
          arduino-cli config set library.enable_unsafe_install true
          arduino-cli core update-index --additional-urls https://arduino.esp8266.com/stable/package_esp8266com_index.json
          arduino-cli core install esp8266:esp8266 --additional-urls https://arduino.esp8266.com/stable/package_esp8266com_index.json
          arduino-cli lib install ArduinoJson "Adafruit NeoPixel" "Adafruit BusIO" "Adafruit GFX Library" "Adafruit SSD1306"
          arduino-cli lib install --git-url https://github.com/me-no-dev/ESPAsyncWebServer.git https://github.com/me-no-dev/ESPAsyncTCP.git
          
      # Compile

      - name: Compile sketch
        run: |
          arduino-cli compile -b "esp8266:esp8266:nodemcuv2" -e ./sketch
      
      # Move file to better place

      - name: Find compiled file
        run: |
          cp ./sketch/build/*.*.*/*.ino.bin ./firmware.bin
          
      # Upload to artifacts

      - name: Upload to artifacts
        uses: actions/upload-artifact@main
        with:
          name: firmware.bin
          path: firmware.bin
